
# Defrock Mod

è¿™æ˜¯ä¸€ä¸ªåŸºäº sugarcube-2-ModLoader çš„ Modï¼Œåœ¨å¯ç”¨è¿™ä¸ª Mod åï¼Œå¯ä»¥ä¸çº¦æ—¦å¯¹è¯ï¼Œè¿›è¡Œ `è¿˜ä¿—` æ“ä½œã€‚
è¿›è¡Œè¿™ä¸ªæ“ä½œä¹‹åï¼Œç©å®¶å°†ä¸å†æ˜¯ä¿¡ä¼—ï¼Œä¸å†éœ€è¦éµå¾ªå…³äºè¡Œä¸ºçš„é™åˆ¶ã€‚ä¹‹åå¯ä»¥å†åº¦ä¸çº¦æ—¦å¯¹è¯é‡æ–°åŠ å…¥ã€‚

This is a Mod based on sugarcube-2-ModLoader. 
After enabling this Mod, you can have a conversation with Jordan to perform the `è¿˜ä¿—` action. 
After completing this action, the player will no longer be a follower and will not need to adhere to 
behavioral restrictions. Later, you can talk to Jordan again to rejoin.

æ­¤å¤–ï¼Œä½ åœ¨å®Œæˆ Sydney çš„å‰§æƒ…åï¼Œå¯ä»¥é€šè¿‡ä¸å…¶åœ¨ `Temple` è¿›è¡Œå¯¹è¯é‡æ–°ç©¿ä¸Š `chastity belt`ï¼Œè¿™ä½¿å¾—ç©å®¶å¯ä»¥ä¸ Sydney é‡æ–°è¿›è¡Œç›¸å…³çš„å‰§æƒ…ã€‚

Additionally, after completing Sydney's storyline, you can talk to her in the `Temple` to put the `chastity belt` back on. 
This allows the player to re-engage in the related storyline with Sydney.

ä» [Release](https://github.com/hxdnshx/sugarcube-2-ModLoader/releases) å¯ä»¥ä¸‹è½½è¿™ä¸ª Mod çš„æœ€æ–°ç‰ˆæœ¬ã€‚

# NoAutoReBuyTrash

è¿™æ˜¯ä¸€ä¸ªä¼˜åŒ–æ¸¸æˆä¸­éƒ¨åˆ†ä½“éªŒçš„Modã€‚å½“ç©å®¶åœ¨äº‹ä»¶ â€œä¸‰è§’ğŸå±•ç¤ºâ€ â€œæµ¸æ°´æ¤…å±•ç¤ºâ€ ä¸­ ç ´å¸ƒè¡£æœ ç­‰ä¸´æ—¶çš„è¡£ç‰©è¢«ç ´åæ—¶ï¼Œä¸å†ä¼šè§¦å‘è¡£ç‰©çš„é‡æ–°è´­ä¹°åŠŸèƒ½ã€‚

This is a Mod that optimizes some aspects of the game experience.
When the player's temporary clothing is damaged during events like "wooden horse" and "ducking stool," 
it will no longer trigger the feature to repurchase the clothing.

ä» [Release](https://github.com/hxdnshx/sugarcube-2-ModLoader/releases) å¯ä»¥ä¸‹è½½è¿™ä¸ª Mod çš„æœ€æ–°ç‰ˆæœ¬ã€‚

# Timehourglass

æ–°å¢äº†é“å…·"æ—¶å…‰é¡¹é“¾"ï¼Œåœ¨æ£®æ—å•†åº—ä¸­å¯ä»¥è´­ä¹°ã€‚è¿™ä¸ªé“å…·åœ¨ä½©æˆ´æ—¶ï¼Œè·å¾—ä»¥ä¸‹æ•ˆæœï¼šæš‚åœé‡å…½ç³»è½¬åŒ–å˜åŠ¨ã€‚
æš‚åœçŸ¥è¯†é—å¿˜ã€‚æš‚åœæ€€å­•è¿›å±•ã€‚æš‚åœå¯„ç”Ÿç‰©çš„çŠ¶æ€å˜åŠ¨ã€‚æš‚åœæ–½è™/å—è™çš„è¡°å‡ã€‚æš‚åœæ„å¿—ç­‰ä¸»è¦å±æ€§çš„ç¼©å‡ã€‚æš‚åœä¸å®‰æ„Ÿçš„ç§¯ç´¯ã€‚

Added the item "Time Necklace", which can be purchased in the Forest Shop. While wearing this item, 
the following effects are obtained: Pause transformation in beast series. Pause knowledge forgetting. 
Pause pregnancy progression. Pause status change of parasites. Pause decay of sadism/masochism. 
Pause reduction of major attributes such as will. Pause accumulation of anxiety.

ä» [Release](https://github.com/hxdnshx/sugarcube-2-ModLoader/releases) å¯ä»¥ä¸‹è½½è¿™ä¸ª Mod çš„æœ€æ–°ç‰ˆæœ¬ã€‚

---

è¯·ä»Releaseä¸‹è½½é¢„ç¼–è¯‘ç‰ˆï¼š[Release](https://github.com/Lyoko-Jeremie/sugarcube-2-ModLoader/releases)   
æˆ–ä¸‹è½½è‡ªåŠ¨æ„å»ºç‰ˆï¼š[DoLModLoaderBuild](https://github.com/Lyoko-Jeremie/DoLModLoaderBuild/actions)   
Please download the precompiled version from the Releaseï¼š[Release](https://github.com/Lyoko-Jeremie/sugarcube-2-ModLoader/releases)   
Or download the automatic build versionï¼š[DoLModLoaderBuild](https://github.com/Lyoko-Jeremie/DoLModLoaderBuild/actions)

---

* [ModLoader](#ModLoader)
  * [ç®€ä»‹](#ç®€ä»‹)
  * [å¦‚ä½•åˆ¶ä½œ Mod.zip æ–‡ä»¶](#å¦‚ä½•åˆ¶ä½œ-modzip-æ–‡ä»¶)
      * [æ³¨æ„äº‹é¡¹](#æ³¨æ„äº‹é¡¹)
  * [å¦‚ä½•æ‰“åŒ…Mod](#å¦‚ä½•æ‰“åŒ…mod)
    * [æ‰‹åŠ¨æ‰“åŒ…æ–¹æ³•](#æ‰‹åŠ¨æ‰“åŒ…æ–¹æ³•) <========= **æœ€ç®€å•çš„æ‰“åŒ…Modæ–¹æ³•**ï¼Œ è‹¥æ²¡æœ‰NodeJsç¯å¢ƒï¼Œè¯·ä½¿ç”¨æ­¤æ–¹æ³•
    * [è‡ªåŠ¨æ‰“åŒ…æ–¹æ³•](#è‡ªåŠ¨æ‰“åŒ…æ–¹æ³•)
  * [ModLoaderå¼€å‘åŠä¿®æ”¹æ–¹æ³•](#ModLoaderå¼€å‘åŠä¿®æ”¹æ–¹æ³•)
  * [æœ‰å…³SC2æ³¨å…¥ç‚¹](#æœ‰å…³SC2æ³¨å…¥ç‚¹)

---

# ç®€ä»‹

æ­¤é¡¹ç›®æ˜¯ä¸º SugarCube-2 å¼•æ“ç¼–å†™çš„ModåŠ è½½å™¨ï¼Œåˆè¡·æ˜¯ä¸º [Degrees-of-Lewdity] è®¾è®¡ä¸€ä¸ªæ”¯æŒModåŠ è½½å’Œç®¡ç†çš„Modæ¡†æ¶ï¼Œæ”¯æŒåŠ è½½æœ¬åœ°Modã€è¿œç¨‹Modã€æ—åŠ è½½Modï¼ˆä»IndexDBä¸­åŠ è½½ï¼‰ã€‚  
This project is a ModLoader written for the SugarCube-2 engine.
The original intention was to design a mod framework that supports mod loading and management for [Degrees-of-Lewdity],
which includes support for loading local mods, remote mods, and side-loaded mods (load from IndexDB).

æœ¬é¡¹ç›®çš„ç›®çš„æ˜¯ä¸ºäº†æ–¹ä¾¿åˆ¶ä½œModä»¥åŠåŠ è½½Modï¼ŒåŒæ—¶ä¹Ÿä¸ºäº†æ–¹ä¾¿åˆ¶ä½œModçš„å¼€å‘è€…ï¼Œæä¾›äº†ä¸€äº›APIæ¥æ–¹ä¾¿è¯»å–å’Œä¿®æ”¹æ¸¸æˆæ•°æ®ã€‚   
The purpose of this project is to facilitate the creation and loading of mods, as well as to provide convenience for mod developers.
It includes some APIs to easily access and modify game data.

æœ¬é¡¹ç›®ç”±äºéœ€è¦åœ¨SC2å¼•æ“å¯åŠ¨å‰æ³¨å…¥Modï¼Œæ•…å¯¹SC2å¼•æ“åšäº†éƒ¨åˆ†ä¿®æ”¹ï¼Œæ·»åŠ äº†ModLoaderçš„å¼•å¯¼ç‚¹ï¼Œä»¥ä¾¿åœ¨å¼•æ“å¯åŠ¨å‰å®ŒæˆModçš„å„é¡¹æ³¨å…¥å·¥ä½œã€‚   
This project has made some modifications to the SC2 engine because it needs to inject mods before the SC2 engine starts.
It has added entry points for the ModLoader to ensure that all mod injection tasks are completed before the engine starts.

ä¿®æ”¹è¿‡çš„ SC2 åœ¨æ­¤å¤„ï¼š[sugarcube-2](https://github.com/Lyoko-Jeremie/sugarcube-2_Vrelnir) ï¼Œä½¿ç”¨æ­¤ModLoaderçš„æ¸¸æˆéœ€è¦ä½¿ç”¨æ­¤ç‰ˆæœ¬çš„SC2å¼•æ“æ‰èƒ½å¼•å¯¼æœ¬ModLoaderã€‚   
The modified SC2 engine can be found here: [sugarcube-2](https://github.com/Lyoko-Jeremie/sugarcube-2_Vrelnir).
To use this ModLoader for games, you need to use this version of the SC2 engine in order to properly load the ModLoader.

å…·ä½“æœ‰å…³å¦‚ä½•æ‰“åŒ…ä¸€ä¸ªå¸¦æœ‰ModLoaderçš„æ¸¸æˆæœ¬ä½“çš„æ–¹æ³•ï¼Œè¯¦è§ [ModLoaderå¼€å‘åŠä¿®æ”¹æ–¹æ³•](#ModLoaderå¼€å‘åŠä¿®æ”¹æ–¹æ³•) ã€‚   
For specific instructions on how to package a game with the ModLoader,
please refer to the details provided in the section titled "ModLoader Development and Modification Methods"
under [ModLoader Development and Modification Methods](#ModLoaderå¼€å‘åŠä¿®æ”¹æ–¹æ³•).

---

# å¦‚ä½•åˆ¶ä½œ Mod.zip æ–‡ä»¶ï¼š  
How to create a Mod.zip file:

ç»™è‡ªå·±çš„modå‘½å  
Name your own mod.

ä»¥modåå­—ç»„ç»‡è‡ªå·±çš„mod  
Organize your mod with the mod's name.

ç¼–å†™modçš„å¼•å¯¼æè¿°æ–‡ä»¶ boot.json æ–‡ä»¶  
Write the boot description file boot.json for your mod.

æ ¼å¼å¦‚ä¸‹ï¼ˆæ ·ä¾‹ src/insertTools/MyMod/boot.jsonï¼‰ï¼š  
The format is as follows (sample src/insertTools/MyMod/boot.json):


```json5
{
  "name": "MyMod",    // ï¼ˆå¿…é¡»å­˜åœ¨ï¼‰ modåå­—
  "version": "1.0.0", // ï¼ˆå¿…é¡»å­˜åœ¨ï¼‰ modç‰ˆæœ¬
  "scriptFileList_inject_early": [  // ï¼ˆå¯é€‰ï¼‰ æå‰æ³¨å…¥çš„ js è„šæœ¬ ï¼Œ ä¼šåœ¨å½“å‰modåŠ è½½åç«‹å³æ’å…¥åˆ°domä¸­ç”±æµè§ˆå™¨æŒ‰ç…§scriptçš„æ ‡æ³¨æ‰§è¡Œæ–¹å¼æ‰§è¡Œ
    "MyMod_script_inject_early_example.js"
  ],
  "scriptFileList_earlyload": [     // ï¼ˆå¯é€‰ï¼‰ æå‰åŠ è½½çš„ js è„šæœ¬ ï¼Œ ä¼šåœ¨å½“å‰modåŠ è½½åï¼Œinject_earlyè„šæœ¬å…¨éƒ¨æ’å…¥å®Œæˆåï¼Œç”±modloaderæ‰§è¡Œå¹¶ç­‰å¾…å¼‚æ­¥æŒ‡ä»¤è¿”å›ï¼Œå¯ä»¥åœ¨è¿™é‡Œè¯»å–åˆ°æœªä¿®æ”¹çš„Passageçš„å†…å®¹
    "MyMod_script_earlyload_example.js"
  ],
  "scriptFileList_preload": [     // ï¼ˆå¯é€‰ï¼‰ é¢„åŠ è½½çš„ js è„šæœ¬æ–‡ä»¶ ï¼Œ ä¼šåœ¨å¼•æ“åˆå§‹åŒ–å‰ã€modçš„æ•°æ®æ–‡ä»¶å…¨éƒ¨åŠ è½½å¹¶åˆå¹¶åˆ°htmlçš„tw-storydataä¸­åï¼Œç”±modloaderæ‰§è¡Œå¹¶ç­‰å¾…å¼‚æ­¥æŒ‡ä»¤è¿”å›ï¼Œ å¯ä»¥åœ¨æ­¤å¤„è°ƒç”¨modloaderçš„APIè¯»å–æœ€æ–°çš„Passageæ•°æ®å¹¶åŠ¨æ€ä¿®æ”¹è¦†ç›–Passageçš„å†…å®¹
    "MyMod_script_preload_example.js"     // æ³¨æ„ scriptFileList_preload æ–‡ä»¶æœ‰å›ºå®šçš„æ ¼å¼ï¼Œå‚è§æ ·ä¾‹ src/insertTools/MyMod/MyMod_script_preload_example.js
  ],
  "styleFileList": [      // ï¼ˆå¿…é¡»å­˜åœ¨ï¼‰ css æ ·å¼æ–‡ä»¶
    "MyMod_style_1.css",
    "MyMod_style_2.css"
  ],
  "scriptFileList": [     // ï¼ˆå¿…é¡»å­˜åœ¨ï¼‰ js è„šæœ¬æ–‡ä»¶ï¼Œè¿™æ˜¯æ¸¸æˆçš„ä¸€éƒ¨åˆ†
    "MyMod_script_1.js",
    "MyMod_script_2.js"
  ],
  "tweeFileList": [       // ï¼ˆå¿…é¡»å­˜åœ¨ï¼‰ twee å‰§æœ¬æ–‡ä»¶
    "MyMod_Passage1.twee",
    "MyMod_Passage2.twee"
  ],
  "imgFileList": [        // ï¼ˆå¿…é¡»å­˜åœ¨ï¼‰ å›¾ç‰‡æ–‡ä»¶ï¼Œå°½å¯èƒ½ä¸è¦ç”¨å®¹æ˜“ä¸æ–‡ä»¶ä¸­å…¶ä»–å­—ç¬¦ä¸²æ··æ·†çš„æ–‡ä»¶è·¯å¾„ï¼Œå¦åˆ™ä¼šæ„å¤–ç ´åæ–‡ä»¶å†…å®¹
    "MyMod_Image/typeAImage/111.jpg",
    "MyMod_Image/typeAImage/222.png",
    "MyMod_Image/typeAImage/333.gif",
    "MyMod_Image/typeBImage/111.jpg",
    "MyMod_Image/typeBImage/222.png",
    "MyMod_Image/typeBImage/333.gif"
  ],
  "additionFile": [     // ï¼ˆå¿…é¡»å­˜åœ¨ï¼‰ é™„åŠ æ–‡ä»¶åˆ—è¡¨ï¼Œé¢å¤–æ‰“åŒ…åˆ°zipä¸­çš„æ–‡ä»¶ï¼Œæ­¤åˆ—è¡¨ä¸­çš„æ–‡ä»¶ä¸ä¼šè¢«åŠ è½½ï¼Œä»…ä½œä¸ºé™„åŠ æ–‡ä»¶å­˜åœ¨
    "readme.txt"      // ç¬¬ä¸€ä¸ªä»¥readme(ä¸åŒºåˆ†å¤§å°å†™)å¼€å¤´çš„æ–‡ä»¶ä¼šè¢«ä½œä¸ºmodçš„è¯´æ˜æ–‡ä»¶ï¼Œä¼šåœ¨modç®¡ç†å™¨ä¸­æ˜¾ç¤º
  ],
  "addonPlugin": [      // ï¼ˆå¯é€‰ï¼‰ ä¾èµ–çš„æ’ä»¶åˆ—è¡¨ï¼Œåœ¨æ­¤å£°æ˜æœ¬modä¾èµ–å“ªäº›æ’ä»¶ï¼Œåœ¨æ­¤å¤„å£°æ˜åä¼šè°ƒç”¨å¯¹åº”çš„æ’ä»¶ï¼Œä¸æ»¡è¶³çš„ä¾èµ–ä¼šåœ¨åŠ è½½æ—¥å¿—ä¸­äº§ç”Ÿè­¦å‘Š
    {           //  éœ€è¦é¦–å…ˆç”±æä¾›æ’ä»¶çš„modåœ¨EarlyLoadé˜¶æ®µæ³¨å†Œæ’ä»¶ï¼Œå¦åˆ™ä¼šæ‰¾ä¸åˆ°æ’ä»¶
      "modName": "MyMod2",    // æ’ä»¶æ¥è‡ªå“ªä¸ªmod
      "addonName": "addon1",   // åœ¨é‚£ä¸ªmodä¸­çš„æ’ä»¶å
      "modVersion": "1.0.0",    // æ’ä»¶æ‰€åœ¨modçš„ç‰ˆæœ¬
      "params": []              // ï¼ˆå¯é€‰ï¼‰ æ’ä»¶å‚æ•°
    }
  ],
  "dependenceInfo": [     // ï¼ˆå¯é€‰ï¼‰ ä¾èµ–çš„modåˆ—è¡¨ï¼Œå¯ä»¥åœ¨æ­¤å£°æ˜æ­¤modä¾èµ–å“ªäº›å‰ç½®modï¼Œä¸æ»¡è¶³çš„ä¾èµ–ä¼šåœ¨åŠ è½½æ—¥å¿—ä¸­äº§ç”Ÿè­¦å‘Š
    {
      "modName": "ModLoader DoL ImageLoaderHook",   // ä¾èµ–çš„modåå­—
      "version": "^2.0.0"                              // ä¾èµ–çš„modç‰ˆæœ¬
    },
    {
      "modName": "ModLoaderGui",
      "version": "^1.0.8"                          // ä¾èµ–çš„modç‰ˆæœ¬ï¼Œä½¿ç”¨(https://www.npmjs.com/package/semver)æ£€æŸ¥ç‰ˆæœ¬å·ï¼Œç¬¦åˆ`è¯­ä¹‰åŒ–ç‰ˆæœ¬æ§åˆ¶è§„èŒƒ` (https://semver.org/lang/zh-CN/)
    },
    {
      "modName": "ModLoader",
      "version": "^1.3.1"
    }
  ]
}

```

æœ€å° boot.json æ–‡ä»¶æ ·ä¾‹ï¼š  
Minimum boot.json file example:

```json
{
  "name": "EmptyMod",
  "version": "1.0.0",
  "styleFileList": [
  ],
  "scriptFileList": [
  ],
  "tweeFileList": [
  ],
  "imgFileList": [
  ],
  "additionFile": [
    "readme.txt"
  ]
}
```

### æ³¨æ„äº‹é¡¹

1. boot.json æ–‡ä»¶å†…çš„è·¯å¾„éƒ½æ˜¯ç›¸å¯¹è·¯å¾„ï¼Œç›¸å¯¹äºzipæ–‡ä»¶æ ¹ç›®å½•çš„è·¯å¾„ã€‚
2. å›¾ç‰‡æ–‡ä»¶çš„è·¯å¾„æ˜¯ç›¸å¯¹äºzipæ–‡ä»¶æ ¹ç›®å½•çš„è·¯å¾„ã€‚
3. åŒä¸€ä¸ªmodå†…çš„æ–‡ä»¶åä¸èƒ½é‡å¤ï¼Œä¹Ÿå°½é‡ä¸è¦å’ŒåŸæ¸¸æˆæˆ–å…¶ä»–modé‡å¤ã€‚ä¸åŸæ¸¸æˆé‡å¤çš„éƒ¨åˆ†ä¼šè¦†ç›–æ¸¸æˆæºæ–‡ä»¶ã€‚
4. å…·ä½“çš„æ¥è¯´ï¼Œmodä¼šæŒ‰ç…§modåˆ—è¡¨ä¸­çš„é¡ºåºåŠ è½½ï¼Œé åçš„modä¼šè¦†ç›–é å‰çš„modçš„passageåŒåæ–‡ä»¶ï¼Œmodä¹‹é—´çš„åŒåcss/jsæ–‡ä»¶ä¼šç›´æ¥å°†å†…å®¹concatåˆ°ä¸€èµ·ï¼Œæ•…ä¸ä¼šè¦†ç›–css/jsç­‰åŒåæ–‡ä»¶ã€‚
5. åŠ è½½æ—¶é¦–å…ˆè®¡ç®—modä¹‹é—´çš„è¦†ç›–ï¼Œï¼ˆäº’ç›¸è¦†ç›–åŒåpassageæ®µè½ï¼Œå°†åŒåjs/cssè¿æ¥åœ¨ä¸€èµ·ï¼‰ï¼Œç„¶åå°†ç»“æœè¦†ç›–åˆ°åŸæ¸¸æˆä¸­ï¼ˆè¦†ç›–åŸç‰ˆæ¸¸æˆçš„åŒåpassage/js/cssï¼‰
6. å½“å‰ç‰ˆæœ¬çš„modåŠ è½½å™¨çš„å·¥ä½œæ–¹å¼æ˜¯ç›´æ¥å°†css/js/tweeæ–‡ä»¶æŒ‰ç…§åŸç‰ˆsc2çš„æ ¼å¼æ’å…¥åˆ°htmlæ–‡ä»¶ä¸­ã€‚

..

1. Paths in the boot.json file are all relative paths, relative to the root directory of the zip file.
2. The paths to image files are relative to the root directory of the zip file.
3. File names within the same mod must not be duplicated, and it's advisable to avoid naming conflicts with the original game or other mods. Parts that overlap with the original game will overwrite game source files.
4. Specifically, mods are loaded in the order they appear in the mod list. Mods further down the list will overwrite passage files with the same name from mods higher up the list. Files with the same name in CSS and JS between mods will have their contents concatenated, so they won't overwrite each other.
5. During loading, mod overlaps are calculated first (overlapping passage paragraphs from different mods, concatenating same-named js/css), and the result is overlaid onto the original game (overwriting same-named passage/js/css of the original game).
6. The current version of the mod loader works by directly inserting CSS/JS/Twee files into the HTML file in the original SC2 format.

---


å¯¹äºä¸€ä¸ªæƒ³è¦ä¿®æ”¹passageçš„modï¼Œæœ‰è¿™ä¹ˆ4ä¸ªå¯ä»¥ä¿®æ”¹çš„åœ°æ–¹
1. scriptFileList_inject_early ï¼Œ è¿™ä¸ªä¼šåœ¨å½“å‰modè¯»å–ä¹‹åï¼Œâ€œç«‹å³â€æ’å…¥åˆ°scriptè„šæœ¬ç”±æµè§ˆå™¨æŒ‰ç…§scriptæ ‡ç­¾çš„æ ‡å‡†æ‰§è¡Œï¼Œè¿™é‡Œå¯ä»¥è°ƒç”¨ModLoaderçš„APIï¼Œå¯ä»¥è¯»å–æœªç»ä¿®æ”¹çš„SC2 data ï¼ˆåŒ…æ‹¬åŸå§‹çš„passageï¼‰
2. scriptFileList_earlyload  ï¼Œè¿™ä¸ªä¼šåœ¨å½“å‰modè¯»å–ä¹‹åï¼Œinject_early è„šæœ¬æ’å…¥å®Œä¹‹åï¼Œç”±modloaderæ‰§è¡Œå¹¶ç­‰å¾…å¼‚æ­¥æŒ‡ä»¤è¿”å›ï¼Œè¿™é‡Œå¯ä»¥è°ƒç”¨ModLoaderçš„APIï¼Œå¯ä»¥æ‰§è¡Œå¼‚æ­¥æ“ä½œï¼Œå¹²ä¸€äº›è¿œç¨‹åŠ è½½ä¹‹ç±»çš„æ´»ï¼Œä¹Ÿå¯ä»¥åœ¨è¿™é‡Œè¯»å–æœªç»ä¿®æ”¹çš„SC2 dataï¼ˆåŒ…æ‹¬åŸå§‹çš„passageï¼‰
3. tweeFileList ï¼Œè¿™ä¸ªæ˜¯modçš„ä¸»ä½“ï¼Œä¼šåœ¨modloaderè¯»å–æ‰€æœ‰modä¹‹åï¼Œåšã€1 åˆå¹¶æ‰€æœ‰modè¿½åŠ çš„æ•°æ®ï¼Œ2 å°†åˆå¹¶ç»“æœè¦†ç›–åˆ°åŸå§‹æ¸¸æˆã€‘çš„è¿‡ç¨‹åº”ç”¨ä¿®æ”¹åˆ°åŸå§‹æ¸¸æˆSC2 dataä¸Š
4. scriptFileList_preload ï¼Œ è¿™ä¸ªä¼šåœ¨modæ–‡ä»¶å…¨éƒ¨åº”ç”¨åˆ°SC2 dataä¹‹åç”±modloaderæ‰§è¡Œå¹¶ç­‰å¾…å¼‚æ­¥æ“ä½œè¿”å›ï¼Œè¿™é‡Œå¯ä»¥åƒearlyloadä¸€æ ·åšå¼‚æ­¥å·¥ä½œï¼Œä¹Ÿå¯ä»¥è¯»å–åˆ°modåº”ç”¨ä¹‹åçš„SC2 data

ä¸Šé¢çš„æ­¥éª¤ç»“æŸä¹‹åSC2å¼•æ“æ‰ä¼šå¼€å§‹å¯åŠ¨ï¼Œè¯»å–SC2 dataï¼Œç„¶åå¼€å§‹æ¸¸æˆï¼Œæ•´ä¸ªæ­¥éª¤éƒ½æ˜¯åœ¨åŠ è½½å±å¹•ï¼ˆé‚£ä¸ªè½¬åœˆåœˆï¼‰å®Œæˆçš„ã€‚

For a mod that wants to modify passages, there are four places you can make modifications:
1. `scriptFileList_inject_early`: This is inserted "immediately" after the current mod is loaded. It is executed by the browser following the standard of script tags. You can call the ModLoader's API here and read unmodified SC2 data, including the original passages.
2. `scriptFileList_earlyload`: This is executed after the current mod is loaded and `inject_early` scripts are inserted. ModLoader executes this and waits for asynchronous instructions to return. You can call the ModLoader's API here, perform asynchronous operations, such as remote loading, and also read unmodified SC2 data, including the original passages.
3. `tweeFileList`: This is the main part of the mod and is applied to the original SC2 data by ModLoader after it reads all mods. It goes through a process of combining all appended data from mods and then overlaying the combined result onto the original game's SC2 data. This is where you apply modifications to the original passages.
4. `scriptFileList_preload`: This is executed by ModLoader after all mod files have been applied to the SC2 data. It waits for asynchronous operations to return. Here, you can perform asynchronous tasks similar to `earlyload` and read the SC2 data after mod application.

After these steps are completed, the SC2 engine starts, reads the SC2 data, and begins the game. The entire process takes place during the loading screen (the spinning wheel).

---

å¦ï¼Œç”±äºSC2å¼•æ“æœ¬èº«ä¼šè§¦å‘ä»¥ä¸‹çš„ä¸€äº›äº‹ä»¶ï¼Œæ•…å¯ä»¥ä½¿ç”¨jQueryç›‘å¬è¿™äº›äº‹ä»¶æ¥ç›‘æµ‹æ¸¸æˆçš„å˜åŒ–  
Additionally, since the SC2 engine itself triggers certain events, you can use jQuery to listen to these events to monitor changes in the game.

```
// æ¸¸æˆå®Œå…¨å¯åŠ¨å®Œæ¯•
:storyready
// ä¸€ä¸ªæ–°çš„ passage ä¸Šä¸‹æ–‡å¼€å§‹åˆå§‹åŒ–
:passageinit
// ä¸€ä¸ªæ–°çš„ passage å¼€å§‹æ¸²æŸ“
:passagestart
// ä¸€ä¸ªæ–°çš„ passage æ¸²æŸ“ç»“æŸ
:passagerender
// ä¸€ä¸ªæ–°çš„ passage å‡†å¤‡æ’å…¥åˆ°HTML
:passagedisplay
// ä¸€ä¸ªæ–°çš„ passage å·²ç»å¤„ç†ç»“æŸ
:passageend
```

å¯ä»¥ä»¥ä¸‹æ–¹æ³•ç›‘å¬jQueryäº‹ä»¶
```js
$(document).one(":storyready", () => {
   // ....... è§¦å‘ä¸€æ¬¡
});
$(document).on(":storyready", () => {
   // ....... è§¦å‘å¤šæ¬¡
});
```
---

### å˜æ›´ï¼š

ã€2023-09-21ã€‘ åˆ é™¤ `imgFileReplaceList` ï¼Œç°åœ¨ä½¿ç”¨æ–°çš„ImageHookLoaderç›´æ¥æ‹¦æˆªå›¾åƒè¯·æ±‚æ¥å®ç°å›¾åƒæ›¿æ¢ï¼Œå› æ­¤ï¼Œä¸åŸå§‹å›¾åƒæ–‡ä»¶é‡åçš„å›¾åƒä¼šè¢«è¦†ç›–

ã€2023-09-23ã€‘ æ·»åŠ  `addonPlugin` ï¼Œæ·»åŠ  `dependenceInfo`

ç°åœ¨å¯ä»¥ä½¿ç”¨ `dependenceInfo` æ¥å£°æ˜ä¾èµ–çš„modï¼Œä¸æ»¡è¶³çš„å£°æ˜ä¼šåœ¨åŠ è½½æ—¥å¿—ä¸­æ˜¾ç¤ºè­¦å‘Š

å¯ä»¥ä½¿ç”¨ `addonPlugin` æ¥å£°æ˜ä¾èµ–çš„æ’ä»¶ï¼Œä¼šåœ¨ `EarlyLoad` ä¹‹å `PatchModToGame` ä¹‹å‰å°†æ‰€æœ‰éœ€è¦ä¾èµ–æ’ä»¶çš„Modæ³¨å†Œç»™æ’ä»¶ï¼Œ  
æ•…æ‰€æœ‰æä¾›æ’ä»¶çš„`æ’ä»¶Mod`ï¼ˆæˆ–è€…è¯´`lib mod`ï¼‰éœ€è¦æœ€è¿Ÿåœ¨ `EarlyLoad` é˜¶æ®µï¼ˆå–œæ¬¢çš„è¯ä¹Ÿå¯ä»¥åœ¨`InjectEarlyLoad`é˜¶æ®µï¼‰
è°ƒç”¨ `window.modAddonPluginManager.registerAddonPlugin()` å°†è‡ªå·±æä¾›çš„æ’ä»¶æ³¨å†Œåˆ° `AddonPluginManager` ã€‚

ã€2023-10-14ã€‘ BreakChange ï¼šç ´åæ€§å˜æ›´ï¼šä¸ºäº†æ”¯æŒ "å®‰å…¨æ¨¡å¼" å’Œ "Modç¦ç”¨åŠŸèƒ½" ï¼Œè°ƒæ•´äº† `InjectEarlyLoad` çš„åŠ è½½å®ç°ä»¥åŠModåŠ è½½è¡Œä¸ºã€‚  

è°ƒæ•´äº† `AddonPluginHook` çš„è§¦å‘é¡ºåºï¼Œ `afterModLoad` ä¼šåœ¨ `afterInjectEarlyLoad` ä¸” ` LifeTimeCircleHook.afterModLoad`  æ‰§è¡Œåè§¦å‘ã€‚  
æ‰€ä»¥ï¼Œå¦‚æœä¸€ä¸ªModéœ€è¦ç­‰å¾…å…¶ä»–Modå¯¹è‡ªå·±ä¿®æ”¹åå†æ‰§è¡Œæ“ä½œï¼ˆä¾‹å¦‚Modå¯¹Modçš„i18nï¼‰ï¼Œå¯ä»¥åœ¨`afterInjectEarlyLoad`ä¸­æˆ–`EarlyLoad`æ—¶å†æ‰§è¡Œè‡ªå·±çš„ä»»åŠ¡ã€‚

ç°åœ¨ ModLoader ä¼šè¯»å–æ‰€æœ‰Modï¼Œç„¶ååœ¨ `InjectEarlyLoad` æ¯ä¸€ä¸ªModåç«‹å³ä½¿ç”¨å‰©ä½™æœªInjectEarlyLoadçš„Modåˆ—è¡¨è°ƒç”¨æ‰€æœ‰å·²åŠ è½½Modçš„`canLoadThisMod`æ¥è¿‡æ»¤æ¥ä¸‹æ¥è¦åŠ è½½çš„Modã€‚  
å³ï¼Œå…ˆåŠ è½½çš„Modå¯ä»¥å†³å®šå‰©ä¸‹è¿˜æœªåŠ è½½çš„Modæ˜¯å¦éœ€è¦ç»§ç»­åŠ è½½ï¼Œä½†å¯¹äºå·²ç»åŠ è½½çš„Modæ²¡æœ‰è¿‡æ»¤èƒ½åŠ›ã€‚

ã€2023-10-08ã€‘ v1.6.0 ä½¿ç”¨ `HtmlTagSrcHook` æ”¯æŒæ›¿æ¢æ¸¸æˆä¸­ç”± SC2 å¼•æ“åˆ›å»ºçš„æ‰€æœ‰ html img æ ‡ç­¾å¼•ç”¨çš„å›¾ç‰‡ã€‚åœ¨æ­¤ä¹‹å‰åªæœ‰canvasç»˜å›¾å¼•ç”¨çš„å›¾ç‰‡æ‰ä¼šè¢«æ›¿æ¢ã€‚

é€šè¿‡å¯¹ SC2 å¼•æ“çš„ `Wikifier.Parser.add 'htmlTag' ` æ·»åŠ å¦‚ä¸‹çš„ä»£ç æ¥åœ¨åˆ›å»º`<IMG>`æ ‡ç­¾å‰æ‹¦æˆªå›¾ç‰‡è¯·æ±‚å¹¶äº¤ç”±ModLoaderè¿›è¡Œå¤„ç†ï¼Œæ¥å®ç°æ‹¦æˆªå¹¶æ›¿æ¢å›¾ç‰‡çš„åŠŸèƒ½ã€‚

```js
if (typeof window.modSC2DataManager !== 'undefined' &&
	typeof window.modSC2DataManager.getHtmlTagSrcHook?.()?.doHook !== 'undefined') {
	if (tagName === 'img' && !el.getAttribute('src')?.startsWith('data:')) {
		// need check the src is not "data:" URI
		el.setAttribute('ML-src', el.getAttribute('src'));
		el.removeAttribute('src');
		// call img loader on there
		window.modSC2DataManager.getHtmlTagSrcHook().doHook(el).catch(E => console.error(E));
	}
}

// ä»¥ä¸‹è¿™è¡Œæ˜¯SC2åŸå§‹ä»£ç ï¼Œä¸Šé¢æ·»åŠ çš„ä»£ç éœ€è¦æ’å…¥åœ¨è¿™ä¸€è¡Œä¹‹å‰
output.appendChild(tagName === 'track' ? el.cloneNode(true) : el);
```

`ModLoader DoL ImageLoaderHook` å·²ç»æ·»åŠ äº†è¿™ä¸ªåŠŸèƒ½çš„æ”¯æŒï¼Œåªéœ€è¦åƒä¹‹å‰é‚£æ ·æ­£å¸¸ä½¿ç”¨å³å¯ã€‚

_ä½¿ç”¨æ­¤åŠŸèƒ½å¯ä»¥é€šè¿‡è‡ªè¡Œæ³¨å†Œ `HtmlTagSrcHook` é’©å­ï¼Œæˆ–è€…ä½¿ç”¨ v2.3.0 ä»¥ä¸Šç‰ˆæœ¬çš„ `ModLoader DoL ImageLoaderHook` ã€‚_

æ³¨ï¼šæ¸¸æˆ DoL ä»ç„¶å­˜åœ¨éƒ¨åˆ†æ²¡æœ‰æ‹¦æˆªåˆ°çš„å›¾ç‰‡ï¼Œè¿™äº›å›¾ç‰‡ç”± DoL è‡ªè¡Œæ·»åŠ äº† `Macro.add("icon",` **icon** æ ‡ç­¾æ¥å®ç°çš„ã€‚è¿™äº›ä»£ç å‡ ä¹å…¨æ˜¯åœ¨ link å‰ä½¿ç”¨çš„æ ‡ç­¾ã€‚




ã€2023-09-21ã€‘ Delete `imgFileReplaceList`. Now, use the new ImageHookLoader to intercept image requests directly for image replacement. Therefore, images with the same name as the original image files will be overwritten.

ã€2023-09-23ã€‘ Add `addonPlugin`. Add `dependenceInfo`.

You can now use `dependenceInfo` to declare dependencies on mods. Declarations that are not met will display warnings in the loading log.  
You can use `addonPlugin` to declare dependencies on plugins. All mods that need to depend on plugins will be registered with the plugin after `EarlyLoad` but before `PatchModToGame`.
Therefore, all mods that provide plugins (or "lib mods") should call `window.modAddonPluginManager.registerAddonPlugin()` to register their provided plugins with the `AddonPluginManager` no later than in the `EarlyLoad` phase (or optionally in the `InjectEarlyLoad` phase).


---

## å¦‚ä½•æ‰“åŒ…Mod  
how to pack mod

### æ‰‹åŠ¨æ‰“åŒ…æ–¹æ³•  
Manual Packaging Method


è¿™ä¸ªæ–¹æ³•åªéœ€è¦æœ‰ä¸€ä¸ªå¯ä»¥å‹ç¼©Zipå‹ç¼©åŒ…çš„å‹ç¼©å·¥å…·ï¼Œå’Œç»†å¿ƒçš„å¿ƒã€‚  
This method only requires a compression tool capable of creating Zip archives and attention to detail.

1. ä½¿ç”¨ä½ å–œçˆ±çš„ç¼–è¾‘å™¨ï¼Œç¼–è¾‘å¥½boot.jsonæ–‡ä»¶  
Use your preferred text editor to edit the boot.json file.

2. åœ¨boot.jsonæ–‡ä»¶æ ¹ç›®å½•ä½¿ç”¨å‹ç¼©å·¥å…·ï¼ˆä¾‹å¦‚å¦‚ä¸‹ä¾‹å­ä¸­ä½¿ç”¨çš„ [7-Zip](7-zip.org/)ï¼Œå…¶ä»–è½¯ä»¶æ–¹æ³•ç±»ä¼¼ï¼‰ï¼Œ**ä»”ç»†é€‰æ‹© boot.json ä»¥åŠåœ¨å…¶ä¸­å¼•ç”¨çš„æ–‡ä»¶æ‰“åŒ…æˆzipæ–‡ä»¶**  
Using a compression tool in the root directory of the boot.json file (for example, as demonstrated below using [7-Zip](7-zip.org/)), **carefully select boot.json and the referenced files within it to create a Zip archive**.

![](https://raw.githubusercontent.com/wiki/Lyoko-Jeremie/sugarcube-2-ModLoader/fast/step1.png)

3. è®¾ç½®å‹ç¼©å‚æ•°ï¼ˆ**æ ¼å¼Zipï¼Œç®—æ³•Deflateï¼Œå‹ç¼©ç­‰çº§è¶Šå¤§è¶Šå¥½ï¼Œæ²¡æœ‰å¯†ç **ï¼‰   
Configure the compression parameters as follows: **Zip format, Deflate algorithm, maximum compression level, and no password.**

![](https://raw.githubusercontent.com/wiki/Lyoko-Jeremie/sugarcube-2-ModLoader/fast/step2.png)

4. ç‚¹å‡»ç¡®å®šï¼Œç­‰å¾…å‹ç¼©å®Œæˆ  
Click "OK" and wait for the compression to complete.

5. å‹ç¼©åè¯·æ‰“å¼€å‹ç¼©æ–‡ä»¶å†æ¬¡æ£€æŸ¥ï¼šï¼ˆ**boot.json æ–‡ä»¶åœ¨æ ¹ç›®å½•**ï¼Œboot.jsonä¸­ç¼–å†™çš„æ–‡ä»¶è·¯å¾„å’Œå‹ç¼©å®Œæ¯•ä¹‹åçš„ç»“æ„**ä¸€æ¨¡ä¸€æ ·**ï¼Œä»»ä½•ä¸€ä¸ªæ–‡ä»¶çš„å‹ç¼©ç®—æ³•åªèƒ½æ˜¯**Storeæˆ–Deflate**ï¼‰  
After compression, please open the compressed file and double-check that: ( **The boot.json file is in the root directory**. The file paths written in boot.json **match** the structure after compression exactly. The compression algorithm for any file should be either **Store or Deflate**. )

![](https://raw.githubusercontent.com/wiki/Lyoko-Jeremie/sugarcube-2-ModLoader/fast/step3.png)


6. é‡å‘½åå‹ç¼©åŒ…ä¸º modåå­—.mod.zip  ï¼ˆè¿™ä¸€æ­¥**å¯é€‰**ï¼‰  
Rename the compressed package to `modname.mod.zip`. (This step is **optional**.)

7. ä½¿ç”¨Modç®¡ç†å™¨åŠ è½½Mod  
Load the Mod using the Mod manager.

### è‡ªåŠ¨æ‰“åŒ…æ–¹æ³•

è¿™ä¸ªæ–¹æ³•éœ€è¦æœ‰NodeJså’ŒYarnä½¿ç”¨çŸ¥è¯†

æ‰“åŒ…ï¼š

ç¼–è¯‘è„šæœ¬

```shell
yarn run webpack:insertTools
```

åˆ‡æ¢åˆ° Mod æ‰€åœ¨æ–‡ä»¶å¤¹ï¼Œï¼ˆå³boot.jsonæ‰€åœ¨æ–‡ä»¶å¤¹ï¼‰
```shell
cd src/insertTools/MyMod
```

æ‰§è¡Œ

```shell
node "<packModZip.js æ–‡ä»¶è·¯å¾„>" "<boot.json æ–‡ä»¶è·¯å¾„>"
```

ä¾‹å¦‚ï¼š

```shell
node "H:\Code\sugarcube-2\ModLoader\dist-insertTools\packModZip.js" "boot.json"
```

ä¹‹åä¼šåœ¨å½“å‰ç›®å½•ä¸‹æ‰“åŒ…ç”Ÿæˆä¸€ä¸ªä»¥boot.jsæ–‡ä»¶ä¸­çš„modåå‘½åçš„zipæ–‡ä»¶ï¼Œä¾‹å¦‚ï¼š

```
MyMod.mod.zip
```


---

# ModLoaderå¼€å‘åŠä¿®æ”¹æ–¹æ³•

**ä»¥ä¸‹æ˜¯å…³äºå¦‚ä½•ä¿®æ”¹ModLoaderæœ¬ä½“ã€å¦‚ä½•å°†ModLoaderæœ¬ä½“ä»¥åŠæ’å…¥åˆ°æ¸¸æˆä¸­ã€å¦‚ä½•å°†é¢„è£…ModåµŒå…¥åˆ°Htmlä¸­çš„æ–¹æ³•ã€‚è‹¥ä»…ä»…åˆ¶ä½œModï¼Œä»…éœ€æŒ‰ç…§ä»¥ä¸Šæ–¹æ³•[æ‰“åŒ…Mod](#å¦‚ä½•æ‰“åŒ…mod)å³å¯åœ¨Modç®¡ç†ç•Œé¢åŠ è½½zipæ–‡ä»¶ã€‚**

---

æœ¬é¡¹ç›®ç”±äºéœ€è¦åœ¨SC2å¼•æ“å¯åŠ¨å‰æ³¨å…¥Modï¼Œæ•…å¯¹SC2å¼•æ“åšäº†éƒ¨åˆ†ä¿®æ”¹ï¼Œæ·»åŠ äº†ModLoaderçš„å¼•å¯¼ç‚¹ï¼Œä»¥ä¾¿åœ¨å¼•æ“å¯åŠ¨å‰å®ŒæˆModçš„å„é¡¹æ³¨å…¥å·¥ä½œã€‚

ä¿®æ”¹è¿‡çš„ SC2 åœ¨æ­¤å¤„ï¼š[sugarcube-2](https://github.com/Lyoko-Jeremie/sugarcube-2_Vrelnir) ï¼Œä½¿ç”¨æ­¤ModLoaderçš„æ¸¸æˆéœ€è¦ä½¿ç”¨æ­¤ç‰ˆæœ¬çš„SC2å¼•æ“æ‰èƒ½å¼•å¯¼æœ¬ModLoaderã€‚

å¯åœ¨SC2æ¸¸æˆå¼•æ“é¡¹ç›®ä¸­æ‰§è¡Œ `build.js -d -u -b 2` æ¥ç¼–è¯‘SC2æ¸¸æˆå¼•æ“ï¼Œç¼–è¯‘ç»“æœåœ¨SC2æ¸¸æˆå¼•æ“é¡¹ç›®çš„ `build/twine2/sugarcube-2/format.js` ï¼Œ
å°†å…¶è¦†ç›– [Degrees-of-Lewdity] æ¸¸æˆçš„åŸç‰ˆ `devTools/tweego/storyFormats/sugarcube-2/format.js` ï¼Œç¼–è¯‘åŸç‰ˆæ¸¸æˆæœ¬ä½“è·å¾—å¸¦æœ‰ModLoaderå¼•å¯¼ç‚¹çš„Htmlæ¸¸æˆæ–‡ä»¶ï¼Œ
éšåæŒ‰ç…§ä¸‹æ–¹çš„æ–¹æ³•ç¼–è¯‘å¹¶æ³¨å…¥æ­¤ModLoaderåˆ°Htmlæ¸¸æˆæ–‡ä»¶ï¼Œå³å¯ä½¿ç”¨æ­¤ModLoaderã€‚

---

ç¼–è¯‘è„šæœ¬

```shell
yarn run webpack:BeforeSC2
yarn run ts:ForSC2
yarn run webpack:insertTools
```

å¦‚ä½•æ’å…¥ModåŠ è½½å™¨ä»¥åŠå°†é¢„è£…Modå†…åµŒåˆ°htmlæ–‡ä»¶ï¼š

ç¼–å†™ modList.json æ–‡ä»¶ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
ï¼ˆæ ·æœ¬å¯å‚è§ src/insertTools/modList.json ï¼‰
```json
[
  "mod1.zip",
  "mod2.zip"
]
```


åˆ‡æ¢åˆ° modList.json æ‰€åœ¨æ–‡ä»¶å¤¹

```shell
cd ./src/insertTools/modList.json
```

```shell
node "<insert2html.js æ–‡ä»¶è·¯å¾„>" "<Degrees of Lewdity VERSION.html æ–‡ä»¶è·¯å¾„>" "<modList.json æ–‡ä»¶>" "<BeforeSC2.js æ–‡ä»¶è·¯å¾„>"
```

ä¾‹å¦‚ï¼š

```shell
node "H:\Code\sugarcube-2\ModLoader\dist-insertTools\insert2html.js" "H:\Code\degrees-of-lewdity\Degrees of Lewdity VERSION.html" "modList.json" "H:\Code\sugarcube-2\ModLoader\dist-BeforeSC2\BeforeSC2.js"
```

ä¼šåœ¨åŸå§‹htmlæ–‡ä»¶åŒç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ªåŒåçš„html.mod.htmlæ–‡ä»¶ï¼Œä¾‹å¦‚ï¼š
```
Degrees of Lewdity VERSION.html.mod.html
```
æ‰“å¼€`Degrees of Lewdity VERSION.html.mod.html`æ–‡ä»¶ï¼Œ play


---

## é™„NodeJsåŠYarnç¯å¢ƒå®‰è£…æ–¹æ³•

1. ä» [NodeJs å®˜ç½‘](https://nodejs.org) ä¸‹è½½NodeJså¹¶å®‰è£…ï¼Œä¾‹å¦‚ [node-v18.18.0-x64.msi](https://nodejs.org/dist/v18.18.0/node-v18.18.0-x64.msi)
2. åœ¨å‘½ä»¤è¡Œè¿è¡Œ `corepack enable` æ¥å¯ç”¨åŒ…ç®¡ç†å™¨æ”¯æŒ
3. ç»“æŸ


---

## æœ‰å…³SC2æ³¨å…¥ç‚¹

ModLoaderæ‰€éœ€çš„å”¯ä¸€ä¸€ä¸ªæ³¨å…¥ç‚¹æ˜¯ [sugarcube.js](https://github.com/Lyoko-Jeremie/sugarcube-2_Vrelnir/blob/TS/src/sugarcube.js) æ–‡ä»¶ä¸­çš„jQueryå¯åŠ¨å¤„

```js
/* eslint-enable no-unused-vars */

/*
	Global `SugarCube` object.  Allows scripts to detect if they're running in SugarCube by
	testing for the object (e.g. `"SugarCube" in window`) and contains exported identifiers
	for debugging purposes.
*/
window.SugarCube = {};

/*
	Main function, entry point for the story.
*/
jQuery(() => {
	'use strict';

	const mainStart = () => {
	    // åŸæ¥çš„ `jQuery(() => {}) `çš„å†…å®¹
	};

	// inject ModLoader on there
	if (typeof window.modSC2DataManager !== 'undefined') {
		window.modSC2DataManager.startInit()
			.then(() => window.jsPreloader.startLoad())
			.then(() => mainStart())
			.catch(err => {
				console.error(err);
			});
	}
	else {
		mainStart();
	}
});
```

éœ€è¦ä½¿ç”¨å¼‚æ­¥ç­‰å¾…çš„æ–¹å¼ï¼Œè®©åŸæœ¬çš„å¼•æ“å¯åŠ¨é€»è¾‘ç­‰å¾…ModLoaderçš„åˆå§‹åŒ–å®Œæ¯•ï¼Œå¹¶ç­‰å¾…ModLoaderå®ŒæˆåŠ è½½æ‰€æœ‰modã€æ‰§è¡Œmodæ³¨å…¥è„šæœ¬ç­‰å¾…ç­‰çš„å·¥ä½œï¼Œä¹‹åæ‰èƒ½æ‰§è¡ŒåŸæœ¬çš„å¼•æ“å¯åŠ¨é€»è¾‘ã€‚



---

## æŠ€æœ¯è¯´æ˜

### åŠ è½½é¡ºåº


ModLoaderä¼šä»4ä¸ªåœ°æ–¹åŠ è½½mod
1. htmlæ–‡ä»¶å†…åµŒçš„ã€localã€‘
2. è¿œç¨‹webæœåŠ¡å™¨ã€remoteã€‘ ï¼ˆå¦‚æœæ˜¯ä½¿ç”¨webæœåŠ¡å™¨æ‰“å¼€å¹¶ä¸”èƒ½è¯»å–åˆ°æœåŠ¡å™¨ä¸Šçš„modList.jsonï¼‰
3. localStorageæ—åŠ è½½ï¼Œä¸Šä¼ æ–‡ä»¶ï¼ˆé™åˆ¶å¤§å°ï¼Œæ‰€ä»¥ç°åœ¨æ²¡æœ‰ä½¿ç”¨ï¼‰ã€localStorageã€‘
4. IndexDBæ—åŠ è½½ï¼Œä¸Šä¼ æ–‡ä»¶ï¼ˆç°åœ¨ç”¨çš„ï¼‰ã€IndexDBã€‘

æŒ‰ç…§1234çš„é¡ºåºåŠ è½½Modï¼Œå¦‚æœæœ‰åŒåModï¼ŒååŠ è½½çš„ä¼šæ›¿ä»£å…ˆåŠ è½½çš„

### Modã€ModLoaderã€å¼•æ“ã€æ¸¸æˆ ä¸‰è€…çš„ç»“æ„

ModLoaderå’Œæ¸¸æˆçš„å…³ç³»å¤§çº¦æ˜¯ `((sc2å¼•æ“ + æ¸¸æˆæœ¬ä½“)[æ¸¸æˆ] + (ModLoader + Mod)[Modæ¡†æ¶])` è¿™ä¸ªç»“æ„

å…¶ä¸­çš„ `Modæ¡†æ¶` åˆç»†åˆ†ä¸º

```
(  
    (
        ModLoader + 
        (
            ModLoaderGui[Modç®¡ç†å™¨ç•Œé¢] +
            Addon[æ‰©å±•æ’ä»¶]
        )[é¢„ç½®Mod]
    )[æ¤å…¥åˆ°html] +  å…¶ä»–Mod[ä¸Šä¼ æˆ–è€…è¿œç¨‹åŠ è½½] 
 )
```

è¦ä½¿ç”¨ModLoaderç©æ¸¸æˆï¼Œéœ€è¦ä½¿ç”¨ç»è¿‡ä¿®æ”¹çš„SC2å¼•æ“ï¼Œä¾‹å¦‚ [è¿™é‡Œ](https://github.com/Lyoko-Jeremie/sugarcube-2_Vrelnir)ï¼Œ  
å…¶ä¸­æœ€å…³é”®çš„éƒ¨åˆ†å°±æ˜¯ä¸Šæ–¹çš„[SC2æ³¨å…¥ç‚¹](#æœ‰å…³SC2æ³¨å…¥ç‚¹)ï¼ŒModLoaderéœ€è¦è¿™ä¸ªæ³¨å…¥ç‚¹æ‰èƒ½å®ç°åœ¨å¼•æ“å¯åŠ¨å‰ä¿®æ”¹å’Œæ³¨å…¥Modçš„å·¥ä½œ

å› ä¸ºå…³ç³»è¾ƒä¸ºå¤æ‚ï¼Œè¿™é‡Œä½¿ç”¨äº†GithubActionæ¥å®ç°è‡ªåŠ¨ç¼–è¯‘

é¢„ç¼–è¯‘ç‰ˆçš„[ä¿®æ”¹ç‰ˆçš„SC2å¼•æ“](https://github.com/Lyoko-Jeremie/sugarcube-2_Vrelnir/actions) å…¶ä¸­æ³¨å…¥äº†ModLoaderçš„å¼•å¯¼ç‚¹   
é¢„ç¼–è¯‘å¥½çš„[ModLoaderä»¥åŠModæ‰“åŒ…å™¨ï¼ˆpackModZip.jsï¼‰å’Œæ³¨å…¥å™¨ï¼ˆinsert2html.jsï¼‰å’Œå‡ ä¸ªAddon](https://github.com/Lyoko-Jeremie/sugarcube-2-ModLoader/actions)   
è‡ªåŠ¨æ‰“åŒ…çš„[åŒ…å«ModLoaderå’ŒAddonçš„åŸç‰ˆDoLæ¸¸æˆ](https://github.com/Lyoko-Jeremie/DoLModLoaderBuild/actions)   


##### æ‰“åŒ…åçš„ç»“æ„

```
((å®šåˆ¶sc2å¼•æ“ + åŸç‰ˆæ¸¸æˆ) + ModLoader)
```

å› ä¸ºModLoaderéœ€è¦åœ¨sc2å¼•æ“å¯åŠ¨ä¹‹å‰æŠŠäº‹æƒ…å…¨éƒ¨åšå®Œï¼Œä½†æ˜¯å¼•æ“çš„å¯åŠ¨äº‹ä»¶æ˜¯æŒ‚åœ¨jqçš„é¡µé¢onLoadedäº‹ä»¶ä¸Šçš„ï¼Œè¿™ä¸ªæ²¡æ³•æ­£å¸¸æ¨è¿Ÿï¼Œ
æ‰€ä»¥æœ€ç›´æ¥çš„è§£å†³åŠæ³•å°±æ˜¯æŠŠsc2å¼•æ“çš„å¯åŠ¨ä»£ç å•ç‹¬æ”¾åˆ°ä¸€ä¸ªå‡½æ•°é‡Œé¢ï¼Œç„¶åè®©ModLoaderåœ¨jqçš„äº‹ä»¶é‡Œé¢å…ˆå¯åŠ¨ï¼Œç­‰å¯åŠ¨å®Œå†è°ƒç”¨åŸæ¥çš„å¯åŠ¨sc2å¼•æ“çš„ä»£ç 

ä½¿å¾—æœ¬æ¥æ˜¯ `jq â†’ sc2` çš„è¿‡ç¨‹ï¼Œå˜æˆ `jq â†’ ModLoader â†’ SC2`



##### å¦‚æœéœ€è¦æ‰‹åŠ¨æ‰“åŒ…ï¼Œéœ€è¦æŒ‰ç…§ä¸‹é¢çš„æ­¥éª¤è¿›è¡Œ

1. æ„å»º `ä¿®æ”¹ç‰ˆçš„SC2å¼•æ“` è·å¾— format.js ï¼Œ
2. è¦†ç›–åˆ°æ¸¸æˆé¡¹ç›®çš„ devTools\tweego\storyFormats\sugarcube-2\format.js ï¼Œå†ç¼–è¯‘æ¸¸æˆå°±å¯ä»¥ç”Ÿæˆå¸¦ä¿®æ”¹ç‰ˆçš„SC2å¼•æ“çš„æ¸¸æˆ
3. ç”¨ModLoaderçš„æ³¨å…¥å™¨(insert2html.js)å°†ModLoaderæ³¨å…¥åˆ°æ¸¸æˆçš„htmlé‡Œã€‚

ä»¥ä¸Šçš„ç¬¬ä¸‰æ­¥åœ¨æ³¨å…¥æ—¶ä¼šå°† `modList.json` ä¸­åˆ—å‡ºçš„Modä½œä¸ºã€Localã€‘ç±»å‹çš„Modä½œä¸ºé¢„ç½®Modä¸€èµ·æ³¨å…¥åˆ°htmlä¸­ï¼Œé»˜è®¤æƒ…å†µä¸‹ `modList.json` ä¸­ä¼šåŒ…å«ModLoaderGuiå’Œä¸€äº›Addon

### æœ‰å…³Addon

ç”±äºå°†æ‰€æœ‰åŠŸèƒ½éƒ½å®ç°åœ¨ModLoaderä¸­æ—¢ä¸ç°å®ä¹Ÿä¸åˆç†ï¼Œç‰¹åˆ«æ˜¯ï¼Œæœ‰å…³ç‰¹å®šæ¸¸æˆçš„åŠŸèƒ½æ›´ä¸åº”è¯¥å®ç°åœ¨ä¸SC2å¼•æ“ç»‘å®šçš„ModLoaderä¸­ï¼Œæ•…ModLoaderæä¾›äº†Addonçš„åŠŸèƒ½ã€‚

Addonæ˜¯ä¸€ç§ç‰¹æ®Šçš„Modï¼Œä½œä¸ºä¸€ç§åŠŸèƒ½æ‰©å±•çš„å½¢å¼å­˜åœ¨ï¼Œé€šè¿‡å°†å¸¸ç”¨åŠŸèƒ½é›†ä¸­åœ¨ä¸€ä¸ªModä¸­ä¾›å…¶ä»–ModLoaderè°ƒç”¨ï¼Œè¿™æ ·çš„Modå°±å¯ä»¥æˆä¸ºAddonã€‚

ä¾‹å¦‚åœ¨RimWorldä¸­çš„ `èº«ä½“æ‰©å±•`ã€`æˆ˜æ–—æ‰©å±•`ã€`å‘é¥°æ‰©å±•` ç­‰ç­‰ï¼Œè¿™äº›Modä½œä¸ºä¸€ç§ä¸­é—´å±‚ï¼Œé€šè¿‡ç›´æ¥æ³¨å…¥å’Œä¿®æ”¹æ¸¸æˆå¹¶æ‰©å±•å‡ºæ–°åŠŸèƒ½æ¥ä¾›å…¶ä»–Modè°ƒç”¨ï¼Œä»¥æ­¤æ¥æ–¹ä¾¿å…¶ä»–modçš„ç¼–å†™ã€‚

ä¾‹å¦‚é¡¹ç›®ä¸­çš„ [ImageLoaderHook](modã€ImageLoaderHook) å°±æ˜¯ä¸€ä¸ªAddonï¼Œ
è¿™ä¸ªModé€šè¿‡æŒ‚é’©DoLæ¸¸æˆä¸­çš„[å›¾ç‰‡åŠ è½½å™¨](Renderer.ImageLoader)ï¼Œå®ç°äº†æŠŠModä¸­çš„å›¾ç‰‡åŠ è½½åˆ°æ¸¸æˆä¸­çš„åŠŸèƒ½ï¼Œæ¸¸æˆåœ¨åŠ è½½å›¾ç‰‡æ—¶å°±ä¼šå»è¯»å–Modä¸­çš„å›¾ç‰‡ã€‚

é¡¹ç›®ä¸­çš„ [CheckDoLCompressorDictionaries](mod/CheckDoLCompressorDictionaries) æ˜¯å¦ä¸€ä¸ªä¸åŒåŠŸèƒ½çš„Addonï¼Œ
è¿™ä¸ªModä»…ä»…æ£€æŸ¥DoLCompressorDictionariesæ•°æ®ç»“æ„ï¼Œå¹¶åœ¨å‘ç°æ•°æ®ç»“æ„å˜åŒ–åå‘å‡ºè­¦ç¤ºï¼Œæ¥æç¤ºModå¼€å‘è€…å’Œä½¿ç”¨è€…é¿å…ä¿®æ”¹DoLCompressorDictionariesï¼Œä»¥é¿å…å½±å“å­˜æ¡£æœ‰æ•ˆæ€§ã€‚

é¡¹ç›®ä¸­çš„ [ReplacePatch](mod/ReplacePatch) å’Œ [TweeReplacer](mod/TweeReplacer) åˆ™å®ç°Passageå’ŒJS/CSSçš„å­—ç¬¦ä¸²æ›¿æ¢åŠŸèƒ½ï¼Œ
å¤§éƒ¨åˆ†éœ€è¦ä¿®æ”¹æ¸¸æˆé€»è¾‘çš„Modå°±ä¸éœ€è¦è‡ªå·±ç¼–å†™ä¿®æ”¹çš„ä»£ç ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨è¿™ä¸¤ä¸ªModæ¥å®ç°å­—ç¬¦ä¸²æ›¿æ¢åŠŸèƒ½ï¼Œ
å°†è¿™ä¸ªåŠŸèƒ½ç‹¬ç«‹å‡ºæ¥ï¼Œé¿å…ModLoaderè¿‡äºè‡ƒè‚¿çš„åŒæ—¶ï¼Œä¹Ÿæ–¹ä¾¿äº†å¯¹æ›¿æ¢åŠŸèƒ½çš„å¿«é€Ÿæ›´æ–°å’Œå‡çº§ï¼Œåœ¨å¿…è¦æ—¶Modä½œè€…å¯ä»¥è‡ªè¡Œfolkæ¥å®ç°æ›´å¤æ‚çš„æ›¿æ¢åŠŸèƒ½è€Œä¸éœ€è¦ä¿®æ”¹ModLoaderçš„ä»£ç ã€‚



---

## åŠ å¯† Mod

ä¸ºäº†æ»¡è¶³éƒ¨åˆ†Modä½œè€…å¯¹å†…å®¹ä¿æŠ¤çš„è¦æ±‚ï¼Œè®¾è®¡äº†åŸºäº libsodium çš„ Mod å†…å®¹ä¿æŠ¤æ¡†æ¶

TODO

---

## TODO

- [x] å®‰å…¨æ¨¡å¼ Safe Mode   
- [ ] Modæ’åº(ModLoaderGUI) Mod sorting    
- [ ] ä¿®æ”¹å…¶ä»–Mod(Mod i18n pack(eg. english a cn mod))  Modify other mods   
- [ ] åœ¨çº¿ç¼–è¾‘passage   
- [ ] æŸ¥çœ‹Diff   
- [ ] æ¸¸æˆå†…Modè®¾ç½®ç•Œé¢   
- [ ] Modç¦ç”¨å¯ç”¨(å¯é€‰åŠ è½½)   
- [ ] Mod-æ¸¸æˆç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥   
- [ ] ä½¿ç”¨Wikifyæ‰§è¡Œscriptæ¥æ³¨å…¥æ¸¸æˆä¸Šä¸‹æ–‡ï¼Œæ³¨å…¥å’Œæ‹¦æˆªjså‡½æ•°å’Œå¯¹è±¡   
- [ ] æä¾›Passage Prefix/Postfix Addonæ¥å®ç°å‰åç¼€æ¨¡å¼(å¯ä»¥ä½¿ç”¨æ³¨å…¥scriptå‡½æ•°å¹¶æ·»åŠ ä¸€è¡Œå‰åç¼€æ ‡ç­¾çš„æ–¹å¼å®ç°)   
- [ ] æä¾›PostPassage Addonæ¥è®¿é—®è¾“å‡ºåçš„html node   
- [ ] Mod Zip åŠ å¯† ( libsodium + å®‰å…¨æ¨¡å¼ + Modç¦ç”¨å¯ç”¨ )   




